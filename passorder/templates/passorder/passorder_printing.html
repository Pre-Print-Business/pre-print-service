{% extends 'base.html' %}
{% load static %}
{% block title %}패스오더 프린팅{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-4">
        <h1 class="fw-bold display-5">패스오더 프린트</h1>
        <p class="text-muted">주문 번호: <strong>{{ order.id }}</strong></p>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <h3 class="fw-bold">출력할 파일 목록</h3>
            {% if files %}
                <ul class="list-group">
                    {% for file in files %}
                        <li class="list-group-item">
                            <a href="{{ file.pass_order_file.url }}" target="_blank">{{ file.pass_order_file.name }}</a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">첨부된 파일이 없습니다.</p>
            {% endif %}

            <!-- 출력 전 주의사항 -->
            <div class="card border-danger shadow-sm mt-4 mb-4">
                <div class="card-header bg-danger bg-opacity-10 border-danger text-center py-3">
                    <i class="fas fa-exclamation-triangle fs-2 text-danger mb-2"></i>
                    <h4 class="fw-bold text-danger mb-0">⚠️ 출력 전 반드시 확인하십시오!</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger border-0 mb-3">
                        <ul class="mb-0 ps-3">
                            <li><strong>출력 버튼을 누르시면 되돌릴 수 없습니다.</strong></li>
                            <li>복합기에 오류가 있는 경우, 인쇄물이 즉시 출력되지 않고 일정 시간이 지난 후 한꺼번에 출력될 수 있습니다.</li>
                            <li><strong>이러한 상황에서는 출력 취소 및 환불이 불가능합니다.</strong></li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-warning border-0 mb-0">
                        <h6 class="fw-bold text-warning mb-2">
                            <i class="fas fa-hand-point-right me-2"></i>반드시 복합기 화면(터치스크린)에서 오류 표시가 없는지 확인해 주십시오.
                        </h6>
                        <ul class="mb-0 ps-3 small">
                            <li>오류는 전체 화면 메시지로 표시되기도 하며, 화면 하단 잉크 아이콘 옆에 <span class="text-warning fw-bold">⚠️ 아이콘</span>으로만 표시되는 경우도 있습니다.</li>
                            <li>두 경우 모두 출력이 정상적으로 진행되지 않을 수 있으니, <strong>아이콘과 메시지를 모두 확인한 후 출력해 주십시오.</strong></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <form method="post" action="{% url 'passorder:passorder_printing' %}" id="printForm">
                    {% csrf_token %}
                    <input type="hidden" name="order_id" value="{{ order.id }}">
                    <button type="button" class="btn btn-primary btn-lg px-5" onclick="confirmPrint()">출력하기</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra-script %}
<script>
function confirmPrint() {
    // 기존 모달 내용을 새로운 내용으로 교체
    const modalTitle = document.getElementById('confirmModalLabel');
    const modalText = document.getElementById('confirmModalText');
    const modalBody = document.querySelector('#confirmModal .modal-body');
    
    modalTitle.innerText = '중요 확인';
    
    // 모달 바디를 완전히 새로운 내용으로 교체
    modalBody.innerHTML = `
        <div class="text-center py-3">
            <div class="mb-3">
                <i class="fas fa-exclamation-triangle text-warning fs-1 mb-3"></i>
            </div>
            <div class="text-start">
                <h6 class="fw-bold text-dark mb-3">출력 버튼을 누르시면:</h6>
                <ul class="text-start mb-3 ps-3">
                    <li><strong>인쇄가 즉시 진행되며 되돌릴 수 없습니다.</strong></li>
                    <li>복합기에 오류가 있는 경우, 인쇄물이 나중에 순차적으로 출력되어 <strong>취소 및 환불이 어렵습니다.</strong></li>
                </ul>
                <div class="alert alert-warning py-2 mb-0">
                    <i class="fas fa-desktop me-2"></i>
                    <strong>📌 복합기에 전체 오류 메시지 또는 하단 아이콘(⚠️)이 없는 것을 확인하셨습니까?</strong>
                </div>
            </div>
        </div>
    `;
    
    // 버튼 텍스트 변경
    const confirmBtn = document.getElementById('confirmModalBtn');
    const cancelBtn = document.querySelector('#confirmModal .btn-secondary');
    
    confirmBtn.innerText = '출력 진행';
    confirmBtn.className = 'btn btn-danger px-4';
    cancelBtn.innerText = '취소';
    
    // 확인 버튼 이벤트 리스너 교체
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.addEventListener('click', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
        modal.hide();
        document.getElementById('printForm').submit();
    });
    
    // 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}
</script>
{% endblock %}
