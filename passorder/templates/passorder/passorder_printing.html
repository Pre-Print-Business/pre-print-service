{% extends 'base.html' %}
{% load static %}
{% block title %}패스오더 프린팅{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-4">
        <h1 class="fw-bold display-5">패스오더 프린트</h1>
        <p class="text-muted">주문 번호: <strong>{{ order.id }}</strong></p>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <h3 class="fw-bold">출력할 파일 목록</h3>
            {% if files %}
                <ul class="list-group">
                    {% for file in files %}
                        <li class="list-group-item">
                            <a href="{{ file.pass_order_file.url }}" target="_blank">{{ file.pass_order_file.name }}</a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">첨부된 파일이 없습니다.</p>
            {% endif %}

            <!-- 출력 전 주의사항 -->
            <div class="card border-danger shadow-sm mt-4 mb-4">
                <div class="card-header bg-danger bg-opacity-10 border-danger text-center py-3">
                    <i class="fas fa-exclamation-triangle fs-2 text-danger mb-2"></i>
                    <h4 class="fw-bold text-danger mb-0">⚠️ 출력 전 반드시 확인하십시오!</h4>
                </div>
                <div class="card-body">
                    <!-- 첫 번째 확인 사항 -->
                    <div class="card mb-3 border-warning">
                        <div class="card-body">
                            <p class="mb-3">
                                <strong>출력 버튼을 누르시면 되돌릴 수 없습니다.</strong><br>
                                복합기에 오류가 있는 경우, 인쇄물이 즉시 출력되지 않고 일정 시간이 지난 후 한꺼번에 출력될 수 있습니다.<br>
                                이러한 상황에서는 <strong>출력 취소 및 환불이 불가능합니다.</strong>
                            </p>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agreement1" name="agreement1">
                                <label class="form-check-label fw-bold text-primary" for="agreement1">
                                    <i class="fas fa-check-circle me-1"></i> 내용을 확인했습니다.
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 두 번째 확인 사항 -->
                    <div class="card mb-3 border-warning">
                        <div class="card-body">
                            <p class="mb-3">
                                <strong>오류는 전체 화면 메시지로 표시되기도 하며, 화면 하단 잉크 아이콘 옆에 ⚠️ 아이콘으로만 표시되는 경우도 있습니다.</strong><br>
                                두 경우 모두 출력이 정상적으로 진행되지 않을 수 있으니, <strong>아이콘과 메시지를 모두 확인한 후 출력해 주십시오.</strong>
                            </p>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agreement2" name="agreement2">
                                <label class="form-check-label fw-bold text-primary" for="agreement2">
                                    <i class="fas fa-check-circle me-1"></i> 내용을 확인했습니다.
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <!-- 체크박스 미완료 시 안내 메시지 -->
                <div id="checkboxGuide" class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>위의 두 확인 사항을 모두 읽고 체크박스를 선택해 주세요.</strong>
                    <br><small class="text-muted">모든 확인 사항에 동의하셔야 출력이 가능합니다.</small>
                </div>

                <form method="post" action="{% url 'passorder:passorder_printing' %}" id="printForm">
                    {% csrf_token %}
                    <input type="hidden" name="order_id" value="{{ order.id }}">
                    <button type="submit" id="printButton" class="btn btn-secondary btn-lg px-5" disabled>
                        <i class="fas fa-lock me-2"></i>출력하기
                    </button>
                </form>

                <!-- 버튼 활성화 시 표시될 안내 -->
                <div id="readyToprint" class="alert alert-success mt-3" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>모든 확인사항을 읽어주셨습니다!</strong> 이제 출력하기 버튼을 클릭하여 인쇄를 시작할 수 있습니다.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra-script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const agreement1 = document.getElementById('agreement1');
    const agreement2 = document.getElementById('agreement2');
    const printButton = document.getElementById('printButton');
    const printForm = document.getElementById('printForm');

    function checkAgreements() {
        const checkboxGuide = document.getElementById('checkboxGuide');
        const readyToPrint = document.getElementById('readyToprint');

        if (agreement1.checked && agreement2.checked) {
            // 모든 체크박스가 체크됨
            printButton.disabled = false;
            printButton.classList.remove('btn-secondary');
            printButton.classList.add('btn-primary');
            printButton.innerHTML = '<i class="fas fa-print me-2"></i>출력하기';

            // 안내 메시지 교체
            checkboxGuide.style.display = 'none';
            readyToPrint.style.display = 'block';
        } else {
            // 체크박스가 미완료
            printButton.disabled = true;
            printButton.classList.remove('btn-primary');
            printButton.classList.add('btn-secondary');
            printButton.innerHTML = '<i class="fas fa-lock me-2"></i>출력하기';

            // 안내 메시지 교체
            checkboxGuide.style.display = 'block';
            readyToPrint.style.display = 'none';
        }
    }

    agreement1.addEventListener('change', checkAgreements);
    agreement2.addEventListener('change', checkAgreements);

    // 폼 제출시 체크박스 확인
    printForm.addEventListener('submit', function(e) {
        if (!agreement1.checked || !agreement2.checked) {
            e.preventDefault();

            // 체크되지 않은 항목들을 강조 표시
            if (!agreement1.checked) {
                const card1 = agreement1.closest('.card');
                card1.classList.add('border-danger');
                card1.classList.remove('border-warning');
                setTimeout(() => {
                    card1.classList.remove('border-danger');
                    card1.classList.add('border-warning');
                }, 3000);
            }
            if (!agreement2.checked) {
                const card2 = agreement2.closest('.card');
                card2.classList.add('border-danger');
                card2.classList.remove('border-warning');
                setTimeout(() => {
                    card2.classList.remove('border-danger');
                    card2.classList.add('border-warning');
                }, 3000);
            }

            // 알림 메시지 표시
            showAlert('모든 확인 사항을 읽고 체크박스를 선택해 주세요.', 'warning');
        }
    });

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);

        // 3초 후 자동으로 사라지게 하기
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }

    // 초기 상태 설정
    checkAgreements();
});
</script>
{% endblock %}
